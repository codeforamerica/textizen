<script>
  $(function() {
    var count = 0;
    appendEmail();
    $(document).on('focus', '.add-email', function(e){
      if (!$(this).hasClass('email-added')){ // only insert a blank email field once per click
        $(this).addClass('email-added');
        $(this).attr('placeholder', "Type a registered user's email"); // update the placeholder text
        appendEmail();
      }
    });
    // show the remove link once an email is entered
    $(document).on('change', 'input.add-email', function(e){
      $(this).parent().find('.remove-email').fadeIn();
    });

    function appendEmail(){
      $('#user-list').append('<li id="emailInput'+(count++)+'"><%= text_field_tag "user_emails[]", params[:email], :class => "input add-email", :placeholder => "Type a registered user’s email"%> <button class="close remove-email" style="display:none" type="button" onclick="removeEmail(this)">×</button></li>');
    }
  });
  function removeEmail(item){
    $(item).parent().remove();
  }
</script>

<%= simple_form_for @group, :html => { :class => "form-horizontal"} do |f| %>
  <%= f.error_notification %>

<h3>People</h3>
<div>Adding some rockstars to this party will give them the same access &mdash; to create and edit polls and view results &mdash; as you. (To share results only, go to the survey page. From there, you can export a CSV or print the webpage to PDF.)</div>
<br>
  <div id="emails">
    <ol id="user-list">
      <li>
      <%= text_field_tag "user_emails[]", params[:email], :placeholder => current_user.email, :disabled => true %><span class="help-inline">You’re automatically a member of any group you create.</span>
      </li>
      <% @group.users.each do |user| %>
        <li>
        <%= user.email %>
        <%= link_to "Remove", group_user_path(GroupUser.where(user_id:user, group_id: @group)[0]), :method => :delete %> 
        </li>
      <% end %>
    </ol>

    <%- if @group.errors.messages && @group.errors.messages[:users] -%>
      <ul>
        <div class="control-group error">
          <%- @group.errors.messages[:users].each do |message| -%>
            <li class="help-block"><%= message[0] -%></li>
          <%- end -%>
        </div>
      </ul>
    <%- end -%>
  </div>


<div style="display:none;">
  <%= f.association :polls, :collection => current_user.visible_polls %>
</div>

<hr>

<h3>Settings</h3>
  <div class="form-inputs">
    <%= f.input :name, :label => "Group name", :hint => "E.g. 'Philadelphia2035' or 'Chattanooga Regional Planning'" %>
    <%= f.input :name, :label => "Preferred area code",
      :collection =>@group.get_exchanges,
      :label_method => lambda {
        |i| label = ""
        label << "#{i['prefix'][1,3]} - #{i['city']}, "
        label << "#{i['state']}, " if !i['state'].blank?
        label << "#{i['country']}"},
        :value_method => lambda {|i| i["prefix"]}
    %>
    <%= f.input :name, :label => "Timezone",
      :collection=>[
        ['Eastern Time','EST'],
        ['Central Time','CST'],
        ['Mountain Time','MST'],
        ['Pacific Time','PST'],
        ['Alaska Time','AKST'],
        ['Hawaii Time','HST']
        ], :selected => "EST", :hint => "Used to timestamp responses. Maybe punted to v3" %>
  </div>

  <div class="form-actions">
    <%= f.button :submit, :class => 'btn btn-large btn-primary' %>
    <%= link_to 'Cancel', groups_path, :class => 'btn btn-large' %>
  </div>
<% end %>
